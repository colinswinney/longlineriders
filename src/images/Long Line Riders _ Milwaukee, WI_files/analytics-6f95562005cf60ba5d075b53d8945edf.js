// bundle contents: shared/js/analytics.js
(function(){var analyticsData=JSON.parse(document.currentScript.dataset.data||"null");var analyticsItems=JSON.parse(document.currentScript.dataset.items||"null");var gaScript=document.createElement("script");gaScript.src="https://www.google-analytics.com/analytics.js";gaScript.async=true;document.head.appendChild(gaScript);window.ga=window.ga||function(){var args=Array.prototype.slice.call(arguments);return(ga.q=ga.q||[]).push(args)};window.Analytics={properties:[],call_queue:[],test_ids:["UA-4189134-10",
"UA-4189134-13"],live_ids:["UA-4189134-2","UA-4189134-11"],environments:{0:{sample_rate:100},1:{sample_rate:100,cookie_domain:"staging.bcdevs.com"},2:{sample_rate:8,use_live_ids:true,cookie_domain:"bandcamp.com"}},dimensions:{LOGIN_STATE:"dimension1",CLIENT_ID:"dimension2"},metrics:{RESPONSE_END_TIME:"metric1",DOM_LOAD_TIME:"metric2",WINDOW_LOAD_TIME:"metric3"},currentCurrency:"USD",data:null,inited:false,ecommerce:false,init:function(){this.data=analyticsData||window.AnalyticsData;if(!this.data||
this.inited)return;if(Identities.bmgr.bands().length>0)this.data.login_state="logged_in_band";else if(Identities.user())this.data.login_state="logged_in_user";else this.data.login_state="not_logged_in";var environment=this.environments[this.data.env];this.data.sample_rate=environment.sample_rate;if(!this.data.our_ids)this.data.our_ids=environment.use_live_ids?this.live_ids:this.test_ids;this.data.cookie_domain=this.data.domain_match?this.data.cookie_domain||environment.cookie_domain:"auto";this.inited=
true;var fullUrl=this.data.send_full_url;this.split=window.location.href.split("?");this.params=this.split[1]&&this.split[1].split("\x26");var hideParams=[];this.params=this.params&&this.params.filter(function(p){var isUTM=p.substr(0,4)==="utm_";var notEmail=p.substr(0,6)!=="email\x3d";if(isUTM)hideParams.push(p.split("\x3d")[0]);return fullUrl?notEmail:isUTM});if(hideParams.length>0)HiddenParams.hide(hideParams);var index=0;this.data.our_ids.forEach(function(id){this.properties.push(this.createPropertySendPageview(id,
true,index));index++},this);if(this.data.band_id)this.createPropertySendPageview(this.data.band_id,false,index);this.collectClientIds();this.sendCheckoutItems();this.sendTimings();this.processQueuedEvents()},createPropertySendPageview:function(id,ours,index){var name=(ours?"bandcamp_":"band_")+index;var createSettings={name:name};if(ours){createSettings.cookieDomain=this.data.cookie_domain;createSettings.sampleRate=this.data.sample_rate}ga("create",id,createSettings);var property={id:id,ours:ours,
name:name,call:function(){var args=Array.prototype.slice.call(arguments);args[0]=property.name+"."+args[0];ga.apply(window,args)}};property.call("set","anonymizeIp",true);property.call("set","forceSSL",true);property.call("set","transport","beacon");if(ours)property.call("set",this.dimensions.LOGIN_STATE,this.data.login_state);if(this.params){var suffix=this.params.length>0?"?"+this.params.join("\x26"):"";var setPage=!this.data.send_full_url?window.location.pathname:window.location.pathname+suffix;
property.call("set","page",setPage);property.call("set","location",this.split[0]+suffix)}property.call("send","pageview");return property},collectClientIds:function(){var self=this;ga(function(){var props=window.Analytics.properties;var trackers=ga.getAll();for(var i=0;i<trackers.length;i++){var id=trackers[i].get("trackingId");var value=trackers[i].get("clientId");for(var pi=0;pi<props.length;pi++){var prop=props[pi];if(prop.id===id)prop.call("set",self.dimensions.CLIENT_ID,value)}}})},sendCheckoutItems:function(){var items=
analyticsItems||window.AnalyticsItems;if(!items||items.length==0)return;var grouped={};items.forEach(function(i){(grouped[i.payment_id]=grouped[i.payment_id]||[]).push(i)});var alwaysSend=false;if(typeof URLSearchParams!=="undefined"){var params=Url.parseQuery(window.location.search);alwaysSend=params&&params.always_send_txns}var cookieName="analytics_processed_ids";var alreadySentIDs=JSON.parse(localStorage.getItem(cookieName)||"[]");var newIDs=[];var i$$0=0;for(var ids=Object.keys(grouped);i$$0<
ids.length;i$$0++)if(alwaysSend||alreadySentIDs.indexOf(ids[i$$0])===-1)newIDs.push(ids[i$$0]);if(newIDs.length==0)return;var byTxnId={};newIDs.forEach(function(id){grouped[id].forEach(function(item){var txn_id=item.txn_id.slice();delete item.payment_id;delete item.txn_id;if(byTxnId[txn_id]==null)byTxnId[txn_id]=[];byTxnId[txn_id].push(item)})});this.requireEcommerce();var analytics=this;Object.keys(byTxnId).forEach(function(id){byTxnId[id].forEach(function(item){analytics.setCurrency(item.currency);
delete item.currency;analytics.callOurProperties("ec:addProduct",item)});analytics.callOurProperties("ec:setAction","purchase",{id:id})});alreadySentIDs=alreadySentIDs.slice(Math.max(alreadySentIDs.length-1E3,0));localStorage.setItem(cookieName,JSON.stringify(alreadySentIDs.concat(newIDs)))},sendTimings:function(){if(!(window.performance&&window.performance.timing))return;if(document.readyState!="complete"){window.addEventListener("load",function(){window.Analytics.sendTimings()});return}var nt=performance.timing;
var navStart=nt.navigationStart;var responseEnd=Math.round(nt.responseEnd-navStart);var domLoad=Math.round(nt.domContentLoadedEventStart-navStart);var windowLoad=Math.round(nt.loadEventStart-navStart);var allValuesAreValid=function(values){var valid=true;values.forEach(function(value){if(value<=0||value>=1E6)valid=false});return valid};if(allValuesAreValid([responseEnd,domLoad,windowLoad])){var event={eventCategory:"Navigation Timing",eventAction:"track",nonInteraction:true};event[this.metrics.RESPONSE_END_TIME]=
responseEnd;event[this.metrics.DOM_LOAD_TIME]=domLoad;event[this.metrics.WINDOW_LOAD_TIME]=windowLoad;this.callOurProperties("send","event",event)}},processQueuedEvents:function(){for(;this.call_queue.length>0;)this.callOurProperties.apply(this,this.call_queue.shift())},callOurProperties:function(){var args=Array.prototype.slice.call(arguments);if(!this.inited){this.call_queue.push(args);return}this.properties.forEach(function(property){if(property.ours)property.call.apply(null,args)})},setCurrency:function(currencyCode){if(currencyCode&&
currencyCode!=this.currentCurrency){this.callOurProperties("set","currencyCode",currencyCode);this.currentCurrency=currencyCode}},cartItemEvent:function(addOrRemove,item){var add=addOrRemove=="add";this.requireEcommerce();this.setCurrency(item.currency);this.callOurProperties("ec:addProduct",{id:item.item_type+item.item_id,name:item.item_title,category:item.item_type,price:item.unit_price,variant:item.is_gift?"gift":"_none",quantity:item.quantity});this.callOurProperties("ec:setAction",add?"add":
"remove");this.callOurProperties("send","event","Checkout",add?"add_to_cart":"remove_from_cart",item.item_type,item.item_id)},requireEcommerce:function(){if(this.ecommerce)return;this.callOurProperties("require","ec");this.ecommerce=true}};window.Analytics.init()})();